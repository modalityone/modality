name: Multi-OS builds
##################################################################################################################
#         This Github workflow will generate the following builds on each push made on the main branch:          #
##################################################################################################################
# Builds generated on Ubuntu:                                                                                    #
#  1) App-Web.war : Web app (built with GWT)                                                                     #
#  2) App-Linux-x64-runnable.jar : Java archive (fat jar with JavaFx for Linux)                                  #
#  3) App-Linux-x64-jvm-package.deb                                                                              #
#  4) App-Linux-x64-jvm-package.rpm                                                                              #
#  5) App-Linux-x64-native-runnable : Linux desktop native app (Gluon)                                           #
#  6) App-Android-aarch64-native-package.apk : Android native app (Gluon)                                        #
# Builds generated on Windows:                                                                                   #
#  7) App-Windows-x64-runnable.jar : Java archive (fat jar with JavaFx for Windows)                              #
#  8) App-Windows-x64-jvm-installer.exe : Windows installer (exe)                                                #
#  9) App-Windows-x64-jvm-installer.msi : Windows installer (msi)                                                #
# 10) App-Windows-x64-native-runnable.exe : Windows desktop native app (Gluon)                                   #
# Builds generated on MacOS:                                                                                     #
# 11) App-MacOS-x64-runnable.jar : Java archive (fat jar with JavaFx for MacOS)                                  #
# 12) App-MacOs-x64-jvm-package.dmg                                                                              #
# 13) App-MacOS-x64-jvm-package.pkg                                                                              #
# 14) App-macOS-x64-native-runnable : MacOS desktop native app (Gluon)                                           #
# 15) App-iOS-arm64-native-package.ipa : iOS native app (Gluon)                                                  #
##################################################################################################################

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        app: [
          {name: 'MongooseBackend',  module-token: 'mongoose-backend', gwt-token: 'mongoose_backend'},
          {name: 'MongooseFrontend', module-token: 'mongoose-frontend', gwt-token: 'mongoose_frontend'}
        ]
        os-config:  [1, 2, 3, 4]
        include:
          - os-config: 1 # Generates builds 1) 2) 3) 4) & 5)
            os: ubuntu-latest
            # Note: 1) must run on Ubuntu because the Github push action (to update the web-build branch) works only on Ubuntu
            web-artifact-suffix:           'Web.war'                            # build 1)
            fatjar-artifact-suffix:        'Linux-x64-runnable.jar'             # build 2)
            jvm-deb-artifact-suffix:       'Linux-x64-jvm-package.deb'          # build 3)
            jvm-rpm-artifact-suffix:       'Linux-x64-jvm-package.rpm'          # build 4)
            gluon-desktop-arch-token:      'x86_64-linux'                       # build 5)
            gluon-desktop-artifact-suffix: 'Linux-x64-native-runnable'          # build 5)

          - os-config: 2 # Generates build 6) - Could be in os-config 1 but moved it a separate config to speed up (parallel run)
            os: ubuntu-latest
            gluon-android-arch-token:      'aarch64-android'                    # build 6)
            gluon-android-artifact-suffix: 'Android-aarch64-native-package.apk' # build 6)

          - os-config: 3 # Generates builds 7) 8) 9) & 10)
            os: windows-latest
            fatjar-artifact-suffix:        'Windows-x64-runnable.jar'           # build 7)
            jvm-exe-artifact-suffix:       'Windows-x64-jvm-installer.exe'      # build 8)
            jvm-msi-artifact-suffix:       'Windows-x64-jvm-installer.msi'      # build 9)
            gluon-desktop-arch-token:      'x86_64-windows'                     # build 10)
            gluon-desktop-artifact-suffix: 'Windows-x64-native-runnable.exe'    # build 10)
            msi-desktop-artifact-suffix:   'Windows-x64-jvm-installer.msi'      # build 9)

          - os-config: 4 # Generates builds 11) 12) 13) 14) & 15)
            os: macos-latest
            fatjar-artifact-suffix:        'MacOS-x64.jar'                      # build 11)
            jvm-dmg-artifact-suffix:       'MacOS-x64-jvm.dmg'                  # build 12)
            jvm-pkg-artifact-suffix:       'MacOS-x64-jvm.pkg'                  # build 13)
            gluon-desktop-arch-token:      'x86_64-darwin'                      # build 14)
            gluon-desktop-Artifact-suffix: 'MacOS-x64-native-runnable'          # build 14)
            # Note: the iOS build needs the Apple certificate in secrets (the steps will be skipped otherwise)
            gluon-ios-arch-token:          'arm64-ios'                          # build 15)
            gluon-ios-artifact-suffix:     'iOS-arm64-native.ipa'               # build 15)

    env:
      application-name: ${{ matrix.app.name }}
      webfx-module:     ./webfx
      this-module:      .
      javafx-module:    ./webfx-demo-${{ matrix.app.module-token }}-application-javafx
      gwt-module:       ./webfx-demo-${{ matrix.app.module-token }}-application-gwt
      gwt-build:        ./webfx-demo-${{ matrix.app.module-token }}-application-gwt/target/webfx-demo-${{ matrix.app.module-token }}-application-gwt-0.1.0-SNAPSHOT/webfx_demo_${{ matrix.app.module-token }}_application_gwt/
      gluon-module:     ./webfx-demo-${{ matrix.app.module-token }}-application-gluon
      web-push-repository-name: 'mongoose' # This same repository (Github doesn't provide ${{ github.repository_name }}
      web-push-repository-owner: ${{ github.repository_owner }}
      web-push-branch: ${{ matrix.app.module-token }}-web-build
      web-push-username: ${{ github.actor }}
      web-push-email: ${{ secrets.API_GITHUB_EMAIL }}
      jdk-version: '15.0.1'
      xcode-version: '11.7.0'
      graalvm-version: '20.3.0.java11'
      API_GITHUB_TOKEN: ${{ secrets.API_GITHUB_TOKEN }}
      GLUON_LICENSE: ${{ secrets.GLUON_LICENSE }}
      GLUON_IOS_CERTIFICATES_FILE_BASE64: ${{ secrets.GLUON_IOS_CERTIFICATES_FILE_BASE64 }}
      GLUON_IOS_APPSTORE_KEY_ID: ${{ secrets.GLUON_IOS_APPSTORE_KEY_ID }}

    steps:

      ##################################################################################################################
      #                                              Preparation                                                       #
      ##################################################################################################################

      # Configure Git for long filenames on Windows (otherwise the WebFx repository checkout will fail)
      - if: runner.os == 'Windows'
        name: Configure Git for long filenames (Windows only)
        run: git config --global core.longpaths true

      # Checkout this repository
      - name: Checkout this repository
        uses: actions/checkout@v2
        with:
          path: ${{ env.this-module }}

      # Checkout WebFx repository (we need to build it as well because there is no release yet)
      - name: Checkout WebFx repository
        uses: actions/checkout@v2
        with:
          repository: 'webfx-project/webfx'
          path: ${{ env.webfx-module }}

      # Set up the JDK (WebFx requires JDK13+ due to javac bugs in prior versions - otherwise JDK11+ should be enough in theory)
      - name: Set up JDK ${{ env.jdk-version }}
        uses: actions/setup-java@v1
        with:
          java-version: ${{ env.jdk-version }}

      # The staging directory will be used to store all artifacts built in this job for upload
      - name: Make staging directory
        run: mkdir staging


      ##################################################################################################################
      #      Building WebFx + this repository (jars + javafx fat jar + javapackager + Web build (GWT) if required)     #
      ##################################################################################################################
      # Builds generated on Ubuntu:                                                                                    #
      #  1) App-Web.war : Web app (built with GWT)                                                                     #
      #  2) App-Linux-x64-runnable.jar : Java archive (fat jar with JavaFx for Linux)                                  #
      #  3) App-Linux-x64-jvm-package.deb                                                                              #
      #  4) App-Linux-x64-jvm-package.rpm                                                                              #
      # Builds generated on Windows:                                                                                   #
      #  7) App-Windows-x64-runnable.jar : Java archive (fat jar with JavaFx for Windows)                              #
      #  8) App-Windows-x64-jvm-installer.exe : Windows installer (exe)                                                #
      #  9) App-Windows-x64-jvm-installer.msi : Windows installer (msi)                                                #
      # Builds generated on MacOS:                                                                                     #
      # 11) App-MacOS-x64-runnable.jar : Java archive (fat jar with JavaFx for MacOS)                                  #
      # 12) App-MacOs-x64-jvm-package.dmg                                                                              #
      # 13) App-MacOS-x64-jvm-package.pkg                                                                              #
      ##################################################################################################################

      # Building the latest WebFx version locally (since there is no public release yet)
      - name: Build WebFx with JDK ${{ env.jdk-version }} (Java 11 target)
        run: mvn -P '!gwt-compile' install
        working-directory: ${{ env.webfx-module }}

      # Building this repository with JDK 13+ (Java 11 target) including a GWT compilation (if required)
      - if: matrix.web-artifact-suffix != null
        name: Build this repository (JavaFx fat jar + GWT build)
        run: mvn -P 'gwt-compile,javafx-fatjar,javapackager' install
        working-directory: ${{ env.this-module }}

      # Or building this repository with JDK 13+ (Java 11 target) excluding a GWT compilation
      - if: matrix.web-artifact-suffix == null
        name: Build this repository (JavaFx fat jar - no GWT build)
        run: mvn -P '!gwt-compile,javafx-fatjar,javapackager' install
        working-directory: ${{ env.this-module }}


      ##################################################################################################################
      #                        Updating the Web build branch (will update the live demo)                               #
      ##################################################################################################################

      - if: matrix.web-artifact-suffix != null && env.API_GITHUB_TOKEN != ''
        name: Push GWT build to ${{ env.web-push-branch }} branch
        uses: cpina/github-action-push-to-another-repository@master
        env:
          API_TOKEN_GITHUB: ${{ secrets.API_GITHUB_TOKEN }}
        with:
          source-directory: ${{ env.gwt-build }}
          destination-repository-username: ${{ env.web-push-repository-owner }}
          destination-repository-name: ${{ env.web-push-repository-name }}
          target-branch: ${{ env.web-push-branch }}
          destination-github-username: ${{ env.web-push-username }}
          user-email: ${{ env.web-push-email }}


      ##################################################################################################################
      #                                           Staging artifacts                                                    #
      ##################################################################################################################
      # On Ubuntu:                                                                                                     #
      #  1) App-Web.war : Web app (built with GWT)                                                                     #
      #  2) App-Linux-x64-runnable.jar : Java archive (fat jar with JavaFx for Linux)                                  #
      #  3) App-Linux-x64-jvm-package.deb                                                                              #
      #  4) App-Linux-x64-jvm-package.rpm                                                                              #
      # On Windows:                                                                                                    #
      #  7) App-Windows-x64-runnable.jar : Java archive (fat jar with JavaFx for Windows)                              #
      #  8) App-Windows-x64-jvm-installer.exe : Windows installer (exe)                                                #
      #  9) App-Windows-x64-jvm-installer.msi : Windows installer (msi)                                                #
      # On MacOS:                                                                                                      #
      # 11) App-MacOS-x64-runnable.jar : Java archive (fat jar with JavaFx for MacOS)                                  #
      # 12) App-MacOs-x64-jvm-package.dmg                                                                              #
      # 13) App-MacOS-x64-jvm-package.pkg                                                                              #
      ##################################################################################################################

      # Staging 1)
      - if: matrix.web-artifact-suffix != null
        name: Copy Web archive to staging
        run: cp ${{ env.gwt-module }}/target/*.war staging/${{ env.application-name }}-${{ matrix.web-artifact-suffix }}

      # Staging 2) | 7) | 11)
      - if: matrix.fatjar-artifact-suffix != null
        name: Copy fat jar with JavaFx to staging
        run: cp ${{ env.javafx-module }}/target/*-fat.jar staging/${{ env.application-name }}-${{ matrix.fatjar-artifact-suffix }}

      # Staging 3)
      - if: matrix.jvm-deb-artifact-suffix != null
        run: cp ${{ env.javafx-module }}/target/javapackager/*.deb staging/${{ env.application-name }}-${{ matrix.jvm-deb-artifact-suffix }} | true

      # Staging 4)
      - if: matrix.jvm-rpm-artifact-suffix != null
        run: cp ${{ env.javafx-module }}/target/javapackager/*.rpm staging/${{ env.application-name }}-${{ matrix.jvm-rpm-artifact-suffix }} | true

      # Staging 8)
      - if: matrix.jvm-exe-artifact-suffix != null
        run: Copy-Item "${{ env.javafx-module }}/target/javapackager/*.exe" -Destination "staging/${{ env.application-name }}-${{ matrix.jvm-exe-artifact-suffix }}"

      # Staging 9)
      - if: matrix.jvm-msi-artifact-suffix != null
        run: |
          dir ${{ env.javafx-module }}/target/javapackager/
          Copy-Item "${{ env.javafx-module }}/target/javapackager/*.msi" -Destination "staging/${{ env.application-name }}-${{ matrix.jvm-msi-artifact-suffix }}"

      # Staging 12)
      - if: matrix.jvm-dmg-artifact-suffix != null
        run: cp ${{ env.javafx-module }}/target/javapackager/*.dmg staging/${{ env.application-name }}-${{ matrix.jvm-dmg-artifact-suffix }} | true

      # Staging 13)
      - if: matrix.jvm-pkg-artifact-suffix != null
        run: cp ${{ env.javafx-module }}/target/javapackager/*.pkg staging/${{ env.application-name }}-${{ matrix.jvm-pkg-artifact-suffix }} | true


      ##################################################################################################################
      #                             Building and staging the Windows installer (msi)                                   #
      ##################################################################################################################
      #  9) App-Windows-x64-jvm-installer.msi : Windows installer (msi)                                                #
      ##################################################################################################################

      # Creating the runtime with jlink and msi with jpackage
      # ${{ env.JAVA_HOME }}\bin\jlink -p "${{ env.JAVA_HOME }}\jmods" --add-modules java.desktop --strip-debug --no-header-files --no-man-pages --strip-native-commands --vm=server --compress=2 --output jlinkImage
      - if: matrix.msi-desktop-artifact-suffix != null
        name: Create Windows Installer (msi)
        run: |
          mvn javafx:jlink
          ${{ env.JAVA_HOME }}\bin\jpackage --input .\target\ --name ${{ env.application-name }} --main-jar webfx-demo-${{ matrix.app.module-token }}-application-javafx-0.1.0-SNAPSHOT.jar --main-class webfx.platform.shared.services.appcontainer.ApplicationContainer --type msi --runtime-image .\target\jlinkImage --app-version 0.0.0 --win-per-user-install --win-menu --win-menu-group WebFx
        working-directory: ${{ env.javafx-module }}

      # Staging 9)
      - if: matrix.msi-desktop-artifact-suffix != null
        name: Copy Windows installer to staging
        run: cp ${{ env.javafx-module }}/*.msi staging/${{ env.application-name }}-${{ matrix.msi-desktop-artifact-suffix }}


      ##################################################################################################################
      #                           Building the native desktop apps using Gluon/GraalVM                                 #
      ##################################################################################################################
      #  5) App-Linux-x64-native-runnable : Linux desktop native app (Gluon)                                           #
      # 10) App-Windows-x64-native-runnable.exe : Windows desktop native app (Gluon)                                   #
      # 14) App-macOS-x64-native-runnable : MacOS desktop native app (Gluon)                                           #
      ##################################################################################################################

      # Windows prerequisite: msbuild
      - if: runner.os == 'Windows'
        name: Add msbuild to PATH (Windows only)
        uses: microsoft/setup-msbuild@v1.0.2

      # Windows prerequisite: Visual Studio shell
      - if: runner.os == 'Windows'
        name: Visual Studio shell (Windows only)
        uses: egor-tensin/vs-shell@v1

      # MacOS prerequisite: Xcode
      - if: runner.os == 'macOS'
        name: Set up Xcode ${{ env.xcode-version }} (MacOS only)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: ${{ env.xcode-version }}

      # Setting up the GraalVM environment
      - name: Set up GraalVM environment ${{ env.graalvm-version }}
        uses: DeLaGuardo/setup-graalvm@master
        with:
          graalvm-version: ${{ env.graalvm-version }}

      # Gluon needs additional libraries on Linux
      - if: runner.os == 'Linux'
        name: Install libraries required for Gluon on Linux
        run: sudo apt install libasound2-dev libavcodec-dev libavformat-dev libavutil-dev libgl-dev libgtk-3-dev libpango1.0-dev libxtst-dev

      # Passing the Gluon License (if set)
      - if: env.GLUON_LICENSE != ''
        name: Gluon License
        uses: gluonhq/gluon-build-license@v1
        with:
          gluon-license: ${{ secrets.GLUON_LICENSE }}

      # Invoking the Gluon Client Maven plugin to build the native Desktop app (chaining build & package goals)
      - if: matrix.gluon-desktop-artifact-suffix != null
        name: Gluon Build for Desktop
        run: mvn -P 'gluon-desktop' client:build client:package # May take a while
        env:
          GRAALVM_HOME: ${{ env.JAVA_HOME }}
        working-directory: ${{ env.gluon-module }}


      ##################################################################################################################
      #                                    Staging the native desktop apps                                             #
      ##################################################################################################################
      #  5) App-Linux-x64-native-runnable : Linux desktop native app (Gluon)                                           #
      # 10) App-Windows-x64-native-runnable.exe : Windows desktop native app (Gluon)                                   #
      # 14) App-macOS-x64-native-runnable : MacOS desktop native app (Gluon)                                           #
      ##################################################################################################################

      # Staging 5) | 14)
      - if: matrix.gluon-desktop-artifact-suffix != null && runner.os != 'Windows'
        name: Copy native Desktop to staging (Linux or MacOS)
        run: cp ${{ env.gluon-module }}/target/client/${{ matrix.gluon-desktop-arch-token }}/webfx-demo-* staging/${{ env.application-name }}-${{ matrix.gluon-desktop-artifact-suffix }}

      # Staging 10)
      - if: matrix.gluon-desktop-artifact-suffix != null && runner.os == 'Windows'
        name: Copy native Desktop to staging (Windows)
        run: Copy-Item "${{ env.gluon-module }}/target/client/${{ matrix.gluon-desktop-arch-token }}/*.exe" -Destination "staging/${{ env.application-name }}-${{ matrix.gluon-desktop-artifact-suffix }}"


      ##################################################################################################################
      #                      Building and staging the native Android app using Gluon/GraalVM                           #
      ##################################################################################################################
      #  6) App-Android-aarch64-native-package.apk : Android native app (Gluon)                                        #
      ##################################################################################################################

      # All prerequisite have already be done when building the Desktop qpps

      # Invoking the Gluon Client Maven plugin to build the native Android app (chaining build & package goals)
      - if: matrix.gluon-android-arch-token != null
        name: Gluon Build for Android
        run: mvn -P 'gluon-android' clean client:build client:package # May take a while
        env:
          GRAALVM_HOME: ${{ env.JAVA_HOME }}
        working-directory: ${{ env.gluon-module }}

      # Staging 6)
      - if: matrix.gluon-android-arch-token != null
        name: Copy Android native application to staging
        run: cp ${{ env.gluon-module }}/target/client/${{ matrix.gluon-android-arch-token }}/gvm/*.apk staging/${{ env.application-name }}-${{ matrix.gluon-android-artifact-suffix }}


      ##################################################################################################################
      #                        Building and staging the native iOS app using Gluon/GraalVM                             #
      ##################################################################################################################
      # 10) App-iOS-arm64-native-package.ipa : iOS native app (Gluon)                                                  #
      ##################################################################################################################

      # Importing the Apple codesign certificates
      - if: env.GLUON_IOS_CERTIFICATES_FILE_BASE64 != ''
        uses: Apple-Actions/import-codesign-certs@v1
        with:
          p12-file-base64: ${{ secrets.GLUON_IOS_CERTIFICATES_FILE_BASE64 }}
          p12-password: ${{ secrets.GLUON_IOS_CERTIFICATES_PASSWORD }}

      # Importing the Apple codesign certificates
      - if: env.GLUON_IOS_APPSTORE_KEY_ID != ''
        uses: Apple-Actions/download-provisioning-profiles@v1
        with:
          bundle-id: ${{ matrix.app.bundle-id }}
          issuer-id: ${{ secrets.GLUON_IOS_APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.GLUON_IOS_APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.GLUON_IOS_APPSTORE_PRIVATE_KEY }}

      # Invoking the Gluon Client Maven plugin to build the native iOS app (chaining build & package goals)
      - if: matrix.gluon-ios-arch-token != null && env.GLUON_IOS_CERTIFICATES_FILE_BASE64 != ''
        name: Gluon Build for iOS
        run: mvn -P 'gluon-ios' clean client:build client:package # May take a while
        env:
          GRAALVM_HOME: ${{ env.JAVA_HOME }}
        working-directory: ${{ env.gluon-module }}

      # Staging 10)
      - if: matrix.gluon-ios-arch-token != null && env.GLUON_IOS_CERTIFICATES_FILE_BASE64 != ''
        name: Copy iOS native application to staging
        run: cp ${{ env.gluon-module }}/target/client/${{ matrix.gluon-ios-arch-token }}/gvm/*.ipa staging/${{ env.application-name }}-${{ matrix.gluon-ios-artifact-suffix }}


      ##################################################################################################################
      #                             Publishing the native iOS app in the Apple Store                                   #
      ##################################################################################################################
      # 10) App-iOS-arm64.ipa : iOS native app (Gluon)                                                                 #
      ##################################################################################################################

      - if: env.GLUON_IOS_APPSTORE_KEY_ID != ''
        uses: Apple-Actions/upload-testflight-build@master
        with:
          app-path: staging/${{ env.application-name }}-${{ matrix.gluon-ios-artifact-suffix }}
          issuer-id: ${{ secrets.GLUON_IOS_APPSTORE_ISSUER_ID }}
          api-key-id: ${{ secrets.GLUON_IOS_APPSTORE_KEY_ID }}
          api-private-key: ${{ secrets.GLUON_IOS_APPSTORE_PRIVATE_KEY }}


      ##################################################################################################################
      #                            Uploading staging artifacts into this workflow assets                               #
      ##################################################################################################################
      # Build-1-assets:                                                                                                #
      #  1) App-Web.war : Web app (built with GWT)                                                                     #
      #  2) App-Linux-x64-runnable.jar : Java archive (fat jar with JavaFx for Linux)                                  #
      #  3) App-Linux-x64-jvm-package.deb                                                                              #
      #  4) App-Linux-x64-jvm-package.rpm                                                                              #
      #  5) App-Linux-x64-native-runnable : Linux desktop native app (Gluon)                                           #
      # Build-2-assets:                                                                                                #
      #  6) App-Android-aarch64-native-package.apk : Android native app (Gluon)                                        #
      # Build-3-assets:                                                                                                #
      #  7) App-Windows-x64-runnable.jar : Java archive (fat jar with JavaFx for Windows)                              #
      #  8) App-Windows-x64-jvm-installer.exe : Windows installer (exe)                                                #
      #  9) App-Windows-x64-jvm-installer.msi : Windows installer (msi)                                                #
      # 10) App-Windows-x64-native-runnable.exe : Windows desktop native app (Gluon)                                   #
      # Build-4-assets:                                                                                                #
      # 11) App-MacOS-x64-runnable.jar : Java archive (fat jar with JavaFx for MacOS)                                  #
      # 12) App-MacOs-x64-jvm-package.dmg                                                                              #
      # 13) App-MacOS-x64-jvm-package.pkg                                                                              #
      # 14) App-macOS-x64-native-runnable : MacOS desktop native app (Gluon)                                           #
      # 15) App-iOS-arm64-native-package.ipa : iOS native app (Gluon)                                                  #
      ##################################################################################################################

      # Uploading all artifacts in the assets of this workflow run
      - name: Upload artifacts in the assets of this worflow run
        uses: actions/upload-artifact@v2
        with:
          name: {{ matrix.app.name }}-os-config-${{ matrix.os-config }}-assets
          path: staging/*



      ##################################################################################################################
      #                         Uploading all artifacts into the SNAPSHOT release assets                               #
      ##################################################################################################################

  upload:
    needs: build # Doing it only once all previous builds have been completed
    runs-on: ubuntu-latest
    env:
      API_GITHUB_TOKEN: ${{ secrets.API_GITHUB_TOKEN }}

    steps:

      - name: Make download directory
        run: mkdir download

      # Downloading the assets generated by the build job in to the staging directory
      # Note: each asset will be a folder containing the artifacts
      - if: env.API_GITHUB_TOKEN != ''
        name: Download artifacts into staging directory
        uses: actions/download-artifact@v2
        with:
          path: download

      - name: Make upload directory
        run: mkdir upload

      # Moving all artifact into the upload directory
      - run: find download -type f -exec mv -t upload {} +

      # Clearing SNAPSHOT release assets
      - if: env.API_GITHUB_TOKEN != ''
        name: Delete old assets in SNAPSHOT release
        uses: mknejp/delete-release-assets@v1
        with:
          tag: SNAPSHOT
          assets: '*'
          fail-if-no-assets: false
          token: ${{ secrets.API_GITHUB_TOKEN }}

      # Upload all artifacts into the SNAPSHOT release assets
      - if: env.API_GITHUB_TOKEN != ''
        name: Upload artifacts to the SNAPSHOT release assets
        uses: AButler/upload-release-assets@v2.0
        with:
          release-tag: SNAPSHOT
          files: upload/*
          repo-token: ${{ secrets.API_GITHUB_TOKEN }}